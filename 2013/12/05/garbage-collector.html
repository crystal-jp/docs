<!DOCTYPE html>
<html lang='en'>
  <head>
    <title>Garbage Collector - The Crystal Programming Language</title>
    <meta charset='utf-8'>
    <!-- Import Google Icon Font -->
    <link href='https://fonts.googleapis.com/icon?family=Material+Icons|Roboto+Mono' rel='stylesheet'>
    <link href="/assets/stylesheet.css" rel="stylesheet" />
    <link href='/feed.xml' rel='alternate' title='Atom 1.0' type='application/atom+xml'>
    <link href='/favicon.png' rel='icon' type='image/png'>
    <link href='/favicon.ico' rel='shortcut icon' type='image/x-icon'>
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Garbage Collector | プログラミング言語 Crystal</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Garbage Collector" />
<meta name="author" content="waj" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Finally Crystal will start giving some memory back to the operating system! Today we managed to fit the Boehm-Demers-Weiser conservative garbage collector into the language." />
<meta property="og:description" content="Finally Crystal will start giving some memory back to the operating system! Today we managed to fit the Boehm-Demers-Weiser conservative garbage collector into the language." />
<link rel="canonical" href="https://ja.crystal-lang.org/2013/12/05/garbage-collector.html" />
<meta property="og:url" content="https://ja.crystal-lang.org/2013/12/05/garbage-collector.html" />
<meta property="og:site_name" content="プログラミング言語 Crystal" />
<meta property="og:image" content="https://ja.crystal-lang.org/assets/icon.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2013-12-05T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://ja.crystal-lang.org/assets/icon.png" />
<meta property="twitter:title" content="Garbage Collector" />
<meta name="twitter:site" content="@CrystalLanguage" />
<meta name="twitter:creator" content="@waj" />
<script type="application/ld+json">
{"datePublished":"2013-12-05T00:00:00+00:00","dateModified":"2013-12-05T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ja.crystal-lang.org/2013/12/05/garbage-collector.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ja.crystal-lang.org/assets/media/crystal_logo.svg"},"name":"waj"},"url":"https://ja.crystal-lang.org/2013/12/05/garbage-collector.html","author":{"@type":"Person","name":"waj"},"@type":"BlogPosting","image":"https://ja.crystal-lang.org/assets/icon.png","headline":"Garbage Collector","description":"Finally Crystal will start giving some memory back to the operating system! Today we managed to fit the Boehm-Demers-Weiser conservative garbage collector into the language.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <!-- Let browser know website is optimized for mobile -->
    <meta content='width=device-width, initial-scale=1.0' name='viewport'>
    <script src='https://code.jquery.com/jquery-3.1.1.min.js' type='text/javascript'></script>
  </head>
  <body>
    <div class="wrapper ">
  <nav role='navigation'>
  <div class='nav-wrapper no-select'>
    
      <a class='brand-logo' id='logo-container'>
        <canvas height='120' id='logo-canvas' style='cursor:move' width='120'></canvas>
      </a>
    
    <ul class='right hide-on-med-and-down' id='nav-desktop'>
      
<li>
    <a href="/">
      Home
    </a>
  </li>
<li>
    <a href="https://forum.crystal-lang.org" target="_blank">
      Forum
    </a>
  </li>
<li>
    <a href="/blog/">
      Blog
    </a>
  </li>
<li>
    <a href="/sponsors/">
      Sponsors
    </a>
  </li>
<li>
    <a href="/community/">
      Community
    </a>
  </li>
<li>
    <a href="/conference/">
      Conference
    </a>
  </li>
<li>
    <a href="/team/">
      Team
    </a>
  </li>
<li>
    <a href="/docs/">
      Docs
    </a>
  </li>
<li>
    <a href="https://github.com/crystal-lang/crystal" target="_blank">
      GitHub
    </a>
  </li>


    </ul>
    <ul class='side-nav' id='nav-mobile'>
      
<li>
    <a href="/">
      Home
    </a>
  </li>
<li>
    <a href="https://forum.crystal-lang.org" target="_blank">
      Forum
    </a>
  </li>
<li>
    <a href="/blog/">
      Blog
    </a>
  </li>
<li>
    <a href="/sponsors/">
      Sponsors
    </a>
  </li>
<li>
    <a href="/community/">
      Community
    </a>
  </li>
<li>
    <a href="/conference/">
      Conference
    </a>
  </li>
<li>
    <a href="/team/">
      Team
    </a>
  </li>
<li>
    <a href="/docs/">
      Docs
    </a>
  </li>
<li>
    <a href="https://github.com/crystal-lang/crystal" target="_blank">
      GitHub
    </a>
  </li>


    </ul>
    <a class='button-collapse' data-activates='nav-mobile' href='#'>
      <i class='material-icons'>menu</i>
    </a>
  </div>
</nav>


  <div class='post-header'>
  <div class="container">
    <div class='valign row'>
      <div class="col m2"></div>
      <div class="col s12 m9">
        <div class="author small">
          
          
            <img src="/assets/authors/waj.jpg" />
          
          
            <span class="author_name">Juan Wajnerman</span>
          
          <span class="date">05 Dec 2013</span>
        </div>

        <h1 class='title'>Garbage Collector</h1>
      </div>
      <div class="col m1"></div>
    </div>
  </div>
</div>


<main>
  <div class="container">
    <div class="row post-layout">
      <div class="col m2 share">
        <p class="title small share-title">Share</p>
        <div class="share-list">
          
          <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fja.crystal-lang.org%2F2013%2F12%2F05%2Fgarbage-collector.html&text=Garbage+Collector&via=CrystalLanguage" target="_blank">
            <div class="share-item"><i class="extra-icons twitter gray"></i></div>
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fja.crystal-lang.org%2F2013%2F12%2F05%2Fgarbage-collector.html" target="_blank">
            <div class="share-item"><i class="extra-icons facebook gray"></i></div>
          </a>
          <a href="https://plus.google.com/share?url=https%3A%2F%2Fja.crystal-lang.org%2F2013%2F12%2F05%2Fgarbage-collector.html" target="_blank">
            <div class="share-item"><i class="extra-icons google_plus gray"></i></div>
            </a>
        </div>
      </div>

      <div class="col s12 m9">
        <p>Finally Crystal will start giving some memory back to the operating system! Today we managed to fit the <a href="https://www.hboehm.info/gc/">Boehm-Demers-Weiser conservative garbage collector</a> into the language.</p>

<p>Although we plan to implement a more appropriate and custom garbage collector in the future, it’s a really good starting point to make the language more robust and usable.</p>

<p>In order to make this collector work with Crystal we had to make sure all the allocated block pointers were properly <a href="https://github.com/crystal-lang/crystal/commit/6657d3c84c93ec0c886aa9262b2a33791e22285f">aligned in memory</a>. Unions and type hierarchies were using packed structs and that made some pointers “invisible” to the GC and thus many blocks still in use were being deallocated and consecuently making everything crash quite easily.</p>

<p>Some quick tests reflect the obvious benefits of freeing some memory. For example, <code class="language-crystal highlighter-rouge"><span class="n">samples</span><span class="o">/</span><span class="n">mandelbrot2</span><span class="p">.</span><span class="nf">cr</span></code> used to require around 13MB of memory to run. Once the GC is enabled it uses just under 1MB.</p>

<p>There is still a long path to travel, but now with a working memory manager we might consider start <a href="http://en.wikipedia.org/wiki/Eating_your_own_dog_food">dogfooding</a> Crystal for some non production or critical tools in our everyday work.</p>

      </div>
      <div class="col m1"></div>
    </div>

    <div class="row disqus">
      <div class="col m2"></div>
      <div class="col s12 m9" id='disqus_thread'>
        <p>Finally Crystal will start giving some memory back to the operating system! Today we managed to fit the <a href="https://www.hboehm.info/gc/">Boehm-Demers-Weiser conservative garbage collector</a> into the language.</p>

<p>Although we plan to implement a more appropriate and custom garbage collector in the future, it’s a really good starting point to make the language more robust and usable.</p>

<p>In order to make this collector work with Crystal we had to make sure all the allocated block pointers were properly <a href="https://github.com/crystal-lang/crystal/commit/6657d3c84c93ec0c886aa9262b2a33791e22285f">aligned in memory</a>. Unions and type hierarchies were using packed structs and that made some pointers “invisible” to the GC and thus many blocks still in use were being deallocated and consecuently making everything crash quite easily.</p>

<p>Some quick tests reflect the obvious benefits of freeing some memory. For example, <code class="language-crystal highlighter-rouge"><span class="n">samples</span><span class="o">/</span><span class="n">mandelbrot2</span><span class="p">.</span><span class="nf">cr</span></code> used to require around 13MB of memory to run. Once the GC is enabled it uses just under 1MB.</p>

<p>There is still a long path to travel, but now with a working memory manager we might consider start <a href="http://en.wikipedia.org/wiki/Eating_your_own_dog_food">dogfooding</a> Crystal for some non production or critical tools in our everyday work.</p>

      </div>
      <div class="col m1"></div>
    </div>
  </div>
</main>


  <footer>
  <div class="row">
    <div class="col s12 m12 l6 crystal">
      Crystal is licensed under the Apache License,
      <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>
        Version 2.0
      </a>
    </div>
    <div class="col s12 m12 l6 manas right-align black-text">
      Crystal language, born & raised at
      <a href="https://manas.tech" target="_blank" class="black-text">Manas</a>
      <a href="https://manas.tech" target="_blank" class="logo">
        <i class="manas"></i>
      </a>
    </div>
  </div>
</footer>

</div>


    <script src="/assets/js/bundle.js"></script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42353458-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
