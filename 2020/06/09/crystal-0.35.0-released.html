<!DOCTYPE html>
<html lang='ja'>
  <head>
    <title>Crystal 0.35.0がリリースされました！ - プログラミング言語 Crystal</title>
    <meta charset='UTF-8'>
    <!-- Import Google Icon Font -->
    <link href='https://fonts.googleapis.com/icon?family=Material+Icons|Roboto+Mono' rel='stylesheet'><link type="text/css" rel="stylesheet" href="/assets/stylesheet.css"><link href='/feed.xml' rel='alternate' title='Atom 1.0' type='application/atom+xml'>
    <link href='/favicon.png' rel='icon' type='image/png'>
    <link href='/favicon.ico' rel='shortcut icon' type='image/x-icon'><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Crystal 0.35.0がリリースされました！ | プログラミング言語 Crystal</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="Crystal 0.35.0がリリースされました！" />
<meta name="author" content="bcardiff,makenowjust" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Crystal 0.35.0 がリリースされました。" />
<meta property="og:description" content="Crystal 0.35.0 がリリースされました。" />
<link rel="canonical" href="https://ja.crystal-lang.org/2020/06/09/crystal-0.35.0-released.html" />
<meta property="og:url" content="https://ja.crystal-lang.org/2020/06/09/crystal-0.35.0-released.html" />
<meta property="og:site_name" content="プログラミング言語 Crystal" />
<meta property="og:image" content="https://ja.crystal-lang.org/assets/icon.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-09T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://ja.crystal-lang.org/assets/icon.png" />
<meta property="twitter:title" content="Crystal 0.35.0がリリースされました！" />
<meta name="twitter:site" content="@CrystalLanguage" />
<meta name="twitter:creator" content="@bcardiff,makenowjust" />
<script type="application/ld+json">
{"dateModified":"2020-06-09T00:00:00+00:00","datePublished":"2020-06-09T00:00:00+00:00","headline":"Crystal 0.35.0がリリースされました！","url":"https://ja.crystal-lang.org/2020/06/09/crystal-0.35.0-released.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://ja.crystal-lang.org/2020/06/09/crystal-0.35.0-released.html"},"image":"https://ja.crystal-lang.org/assets/icon.png","author":{"@type":"Person","name":"bcardiff,makenowjust"},"description":"Crystal 0.35.0 がリリースされました。","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://ja.crystal-lang.org/assets/media/crystal_logo.svg"},"name":"bcardiff,makenowjust"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
 <!-- Let browser know website is optimized for mobile --><meta content='width=device-width, initial-scale=1.0' name='viewport'>
    <script src='https://code.jquery.com/jquery-3.1.1.min.js' type='text/javascript'></script>
  </head>
  <body>
    <!-- <div class="top-banner">
  <a href="https://www.eventbrite.co.uk/e/raw-crystal-2020-tickets-127439094763" target="_blank">
    <span class="tb-title">RAW CRYSTAL<span class="tb-thin"> | 2020</span></span>
    <span class="tb-gap"></span>
    <span class="tb-date">Dec 11</span>
    <span class="tb-register">REGISTER AT <em>Eventbrite</em></span>
  </a>
</div>
 -->
    <div class="wrapper "><nav role='navigation'>
  <div class='nav-wrapper no-select'>
    
      <a class='brand-logo' id='logo-container'>
        <canvas height='120' id='logo-canvas' style='cursor:move' width='120'></canvas>
      </a>
    
    <ul class='right hide-on-med-and-down' id='nav-desktop'>
      
<li>
    <a href="/">
      Home
    </a>
  </li>
<li>
    <a href="https://forum.crystal-lang.org" target="_blank">
      Forum
    </a>
  </li>
<li>
    <a href="/blog/">
      Blog
    </a>
  </li>
<li>
    <a href="/sponsors/">
      Sponsors
    </a>
  </li>
<li>
    <a href="/community/">
      Community
    </a>
  </li>
<li>
    <a href="/team/">
      Team
    </a>
  </li>
<li>
    <a href="/docs/">
      Docs
    </a>
  </li>
<li>
    <a href="https://github.com/crystal-lang/crystal" target="_blank">
      GitHub
    </a>
  </li>


    </ul>
    <ul class='side-nav' id='nav-mobile'>
      
<li>
    <a href="/">
      Home
    </a>
  </li>
<li>
    <a href="https://forum.crystal-lang.org" target="_blank">
      Forum
    </a>
  </li>
<li>
    <a href="/blog/">
      Blog
    </a>
  </li>
<li>
    <a href="/sponsors/">
      Sponsors
    </a>
  </li>
<li>
    <a href="/community/">
      Community
    </a>
  </li>
<li>
    <a href="/team/">
      Team
    </a>
  </li>
<li>
    <a href="/docs/">
      Docs
    </a>
  </li>
<li>
    <a href="https://github.com/crystal-lang/crystal" target="_blank">
      GitHub
    </a>
  </li>


    </ul>
    <a class='button-collapse' data-activates='nav-mobile' href='#'>
      <i class='material-icons'>menu</i>
    </a>
  </div>
</nav>
   <div class='post-header'>
  <div class="container">
    <div class='valign row'>
      <div class="col m2"></div>
      <div class="col s12 m9">
        <div class="author small">
          
          
            <img src="/assets/authors/bcardiff.jpg" width="360" height="360" alt="authors/bcardiff.jpg">
          
            <img src="/assets/authors/makenowjust.jpg" width="200" height="200" alt="authors/makenowjust.jpg">
          
          
            <span class="author_name">Brian J. Cardiff</span>
          
            <span class="author_name">TSUYUSATO Kitsune (翻訳)</span>
          
          
          
            <span class="date">09 Jun 2020</span>
          
        </div>

        <h1 class='title'>Crystal 0.35.0がリリースされました！</h1>
      </div>
      <div class="col m1"></div>
    </div>
  </div>
</div>
  <main><div class="container">
  <div class="row post-layout">
    <div class="col m2 share">
      <p class="title small share-title">Share</p>
      <div class="share-list">
        
        <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fja.crystal-lang.org%2F2020%2F06%2F09%2Fcrystal-0.35.0-released.html&text=Crystal+0.35.0%E3%81%8C%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%81%95%E3%82%8C%E3%81%BE%E3%81%97%E3%81%9F%EF%BC%81&via=CrystalLanguage" target="_blank">
          <div class="share-item"><i class="extra-icons twitter gray"></i></div>
        </a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fja.crystal-lang.org%2F2020%2F06%2F09%2Fcrystal-0.35.0-released.html" target="_blank">
          <div class="share-item"><i class="extra-icons facebook gray"></i></div>
        </a>
        <a href="https://plus.google.com/share?url=https%3A%2F%2Fja.crystal-lang.org%2F2020%2F06%2F09%2Fcrystal-0.35.0-released.html" target="_blank">
          <div class="share-item"><i class="extra-icons google_plus gray"></i></div>
          </a>
      </div>
    </div>

    <div class="col s12 m9">
      <p><a href="https://github.com/crystal-lang/crystal/releases/tag/0.35.0">Crystal 0.35.0</a> がリリースされました。</p>

<p>今回のリリースはみなさんの待ち望んでいた、1.0直前の標準ライブラリに磨きをかけるものです。この中には最近のいくつかの追加やより洗練された実装の繰り返しといった、多くの活動があります。他には、デバッグの改善や Windows のサポート、その他のプラットフォームでのランタイムの安定化などを含みます。</p>

<p>このリリースが最後のバージョン 0.x のリリースになるでしょう。1.0.0-preX のリリースに向けて準備をしていてください。</p>

<p>38人のコントリビューターによって<a href="https://github.com/crystal-lang/crystal/compare/0.34.0...0.35.0">0.34.0から242のコミット</a>がありました。</p>

<p>それでは今回のリリースのハイライトを紹介していきます。たくさんの紹介するものがあります。ですが、<a href="https://github.com/crystal-lang/crystal/releases/tag/0.35.0">リリースのチェンジログ</a>にもたくさんの価値ある情報があることを忘れないでください。</p>

<h2 id="言語の変更">言語の変更</h2>

<h3 id="網羅性チェック-テイク2">網羅性チェック (テイク2)</h3>

<p><a href="/2020/04/06/crystal-0.34.0-released.html#exhaustive-case">前回のリリース</a>で、コンパイラは case 文の条件節の網羅性チェックをするようになりました。ですが、フィーバックを受けて、次のことを決定しました。</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">case ... when</code> を前のように戻す。暗黙の <code class="language-plaintext highlighter-rouge">else nil</code> があって、条件節は網羅的でなくてもよい。</li>
  <li><code class="language-plaintext highlighter-rouge">case ... in</code> 文を実験的に導入する。こちらは暗黙の <code class="language-plaintext highlighter-rouge">else</code> を持たず、条件の網羅性が確認できなければコンパイルが通らない。実験的というのはフォードバックを元に変更される可能性がある、ということです。たとえマイナーリリースの間でも、その変更は行なわれる可能性があります。</li>
</ol>

<p>この決定によって <code class="language-plaintext highlighter-rouge">case ...  when</code> の意味は身近なままとなり、既存のコードに影響することなく網羅性チェックをする case 文を洗練させていくことが可能になります。より詳細な議論は<a href="https://github.com/crystal-lang/crystal/pull/9258">#9258</a>と<a href="https://github.com/crystal-lang/crystal/pull/9045">#9045</a>を参照してください。</p>

<div class="code_section">
<figure class="highlight"><pre><code class="language-crystal" data-lang="crystal"><span class="c1"># Compiles! Totally fine</span>
<span class="k">case</span> <span class="mi">1</span> <span class="o">||</span> <span class="s2">"a"</span>
<span class="k">when</span> <span class="no">Int32</span>
<span class="k">end</span>

<span class="c1"># Error: missing case String</span>
<span class="k">case</span> <span class="mi">1</span> <span class="o">||</span> <span class="s2">"a"</span>
<span class="k">in</span> <span class="no">Int32</span>
<span class="k">end</span></code></pre></figure>
</div>

<p>この変更によって <code class="language-plaintext highlighter-rouge">in</code> が正式なキーワードとなりました。これは破壊的な変更ですが、<code class="language-plaintext highlighter-rouge">in</code> はこれまでもマクロ中ではキーワードとして扱われていました。</p>

<h2 id="コンパイラ">コンパイラ</h2>

<p>コンパイラに破壊的な変更があり、コンパイラの CLI がシバン <code class="language-plaintext highlighter-rouge">#!</code> によるスクリプトをより安心して動作させられるようになりました。これからは、コマンドの代わりにファイルを引数にしてコンパイラを実行すると (<code class="language-plaintext highlighter-rouge">crystal path/to/file.cr arg1 arg2</code> のように)、ファイルがコンパイルされて、そしてそれを実行する、という動作をします。このとき、引数はプログラムにだけ影響して、コンパイラに影響しない、ということです。</p>

<p>コンパイラフラグを使いたい場合や引数と共にプログラムを実行したい場合は、次のように run コマンドが使えます。<code class="language-plaintext highlighter-rouge">crystal run path/to/file.cr -Dcompiler_flag --release -- arg1 arg2</code><code class="language-plaintext highlighter-rouge">--</code> はコンパイラのオプションとプログラムのオプションを切り分けます。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9171">#9171</a>を確認してください。</p>

<p>他の破壊的な変更としては、<code class="language-plaintext highlighter-rouge">crystal env</code> がシェル向けにクオートをするようになりました。つまり、<code class="language-plaintext highlighter-rouge">eval "$(crystal env)"</code> が安全にできるようになったということです。また、<code class="language-plaintext highlighter-rouge">crystal env VARIABLE</code> はこれまでの通りです。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9428">#9428</a>を確認してください。</p>

<p>パーサーはたくさんの愛を受けました。エッジケースの修正や、そこそこのリファクタリングが<a href="https://github.com/crystal-lang/crystal/pull/9208">#9208</a>でされています。</p>

<p>言語のいくつかの機能はより良い動作のために反芻が必要でした。このリリースではオートキャストが多重ディスパッチやユニオンのデフォルト値に対して動作するようになりました。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9004">#9004</a>と<a href="https://github.com/crystal-lang/crystal/pull/9366">#9366</a>を確認してください。これはいくつかの場合の予期しない残念な挙動を解決するでしょう。</p>

<p>既存の機能の改善の背景には、Crystal のデバッグ機能の改善を待ち望まれていたことがあります。この改善はまだ完了してはいませんが、<a href="https://github.com/crystal-lang/crystal/pull/8538">#8538</a>で大きな一歩を踏み出すことができました。この <a href="https://dev.to/bcardiff/debug-crystal-in-vscode-via-codelldb-3lf">VSCode で Crystal のプログラムをどうやってデバッグするかを説明した記事</a>で、どう設定すれば良いかや、スクリーンショットを確認できます。</p>

<p><code class="language-plaintext highlighter-rouge">@[Link]</code> アノテーションは少しだけ再デザインされました。pkg-config とより統合されて、<code class="language-plaintext highlighter-rouge">static:</code> オプションのサポートが無くなりました。これによって将来、デフォルト値をいい感じに提供しつつ、リンクを詳細に設定できるようにすることを見据えています。詳細は<a href="https://github.com/crystal-lang/crystal/pull/8972">#8972</a>を確認してください。</p>

<p><strong>Crystal パッケージのメンテナにとって</strong>、コンパイラをビルドする際に<code class="language-plaintext highlighter-rouge">CRYSTAL_CONFIG_PATH</code> が標準ライブラリのパスのみを必要とするようになったという知らせは価値があるでしょう。<code class="language-plaintext highlighter-rouge">lib</code> ディレクトリはコンパイラによって常に含まれるようになりました。将来的には shaeds のインストールパスを細かく設定できるようにしたいと考えています。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9315">#9315</a>を確認してください。</p>

<p>その他の変更として、<code class="language-plaintext highlighter-rouge">SOURCE_DATE_EPOCH</code> という環境変数を使うことでコンパイラをビルドする際にソースコードの時刻を伝えることができるようになりました。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9088">#9088</a>を確認してください。</p>

<h2 id="shards">Shards</h2>

<p>Shards v0.11.1 が今回のリリースではバンドルされます。</p>

<p>今回の把握すべき主要な変更は <code class="language-plaintext highlighter-rouge">crystal:</code> プロパティが<strong>効果的に機能する</strong>ようになった点です。このプロパティは、有効な shard のバージョンを Crystal 環境に基いて決定するのに使われます。詳細は動作は <a href="https://github.com/crystal-lang/shards/blob/v0.11.1/SPEC.md#crystal">shards/SPEC.md</a> を確認してください。</p>

<p>後方互換性のために <code class="language-plaintext highlighter-rouge">crystal:</code> プロパティが <code class="language-plaintext highlighter-rouge">shard.yml</code> に無かった場合、<code class="language-plaintext highlighter-rouge">&lt; 1.0.0</code>として解釈されます。よって、Crystal 1.0.0 まではそのままでも動作し続けるでしょう。また、この挙動が不便な場合は、<code class="language-plaintext highlighter-rouge">--ignore-crystal-version</code> を渡すことでこのチェックを無視できます。</p>

<p>利用者の期待を高めるには、依存するバージョンを明示する必要があると考えられます。そして、標準ライブラリや言語のバージョンもまた依存関係なのです。</p>

<p><code class="language-plaintext highlighter-rouge">crystal:</code> プロパティの動作は依存関係のバージョン指定とほとんど同じように動作します。違いは、利便性のため <code class="language-plaintext highlighter-rouge">crystal: x.y.z</code> が <code class="language-plaintext highlighter-rouge">~&gt; x.y, &gt;= x.y.z</code> のように (つまり、 <code class="language-plaintext highlighter-rouge">&gt;= x.y.z, &lt; (x+1).0.0</code>) 解釈されることです。この結果、任意の<strong>メジャー</strong>リリースで何らかの対応が必要になります。</p>

<p><code class="language-plaintext highlighter-rouge">shards install</code> を現在のプロジェクトで実行することを推奨します。これによって、<code class="language-plaintext highlighter-rouge">shard.lock</code> がいくつかの追加の新しいバージョンのフォーマットを持つことに気付くかもしれません。そして、<code class="language-plaintext highlighter-rouge">lib/.shards.info</code> ファイルがインストールした依存関係を説明するものとして追加されています。この新しいファイルはバージョン管理システムでトラックする必要はありません。</p>

<p>最後に、依存関係のバージョン指定で <code class="language-plaintext highlighter-rouge">version: &gt;= 1.0.0, &lt; 2.0</code> のように複数の指定を交差させられるようになったことを紹介します。</p>

<p>このバージョンでの shards の完全な変更のリストは<a href="https://github.com/crystal-lang/shards/releases/tag/v0.11.0">チェンジログ</a>を参照してください。</p>

<h2 id="標準ライブラリ">標準ライブラリ</h2>

<p>このリリースにはいくつもの破壊的変更が含まれます。それらの大半は普通、非推奨の警告が出るようになっています。標準ライブラリの整理なしに1.0へと進むことはないつもりです。このような整理は以前にもあったはずです。これに優先順位を付けることは簡単ではなく、地道に進めています。</p>

<p>計算結果の出力や入力に <code class="language-plaintext highlighter-rouge">IO</code> を引数に取る多くのメソッドがあります。<a href="https://github.com/crystal-lang/crystal/issues/5916">#5916</a> で、このような引数を最初の引数にすることを標準化する提案がありました。これは <a href="https://github.com/crystal-lang/crystal/pull/9134">#9134</a> といくつかのそれに続く PR で実現されました。</p>

<p>これらのすべての <code class="language-plaintext highlighter-rouge">IO</code> メソッドに関係して、<code class="language-plaintext highlighter-rouge">String</code> クラスのメソッドで、<code class="language-plaintext highlighter-rouge">String</code> の値を返すものについて、値を返すのではなく結果を <code class="language-plaintext highlighter-rouge">IO</code> に書き込むようなオーバロードが追加されました。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9236">#9236</a>を確認してください。この影響を受けるのは <code class="language-plaintext highlighter-rouge">#underscore</code>、<code class="language-plaintext highlighter-rouge">#titleize</code>、<code class="language-plaintext highlighter-rouge">#capitalize</code>、<code class="language-plaintext highlighter-rouge">#upcase</code>、そして<code class="language-plaintext highlighter-rouge">#downcase</code> といったメソッドです。</p>

<blockquote>
  <p>文字列のインターポレーションの際に生成された文字列が直接 <code class="language-plaintext highlighter-rouge">IO</code> に渡されるようにするための改善の提案として、<a href="https://github.com/crystal-lang/crystal/issues/9291">#9291</a>に目を通しておくといいでしょう。</p>
</blockquote>

<p>その他の <code class="language-plaintext highlighter-rouge">IO</code> の破壊的な変更としては、<code class="language-plaintext highlighter-rouge">#skip</code>、<code class="language-plaintext highlighter-rouge">#write</code>、<code class="language-plaintext highlighter-rouge">#write_utf8</code>、<code class="language-plaintext highlighter-rouge">#write_byte</code>、<code class="language-plaintext highlighter-rouge">#write_bytes</code>、や<code class="language-plaintext highlighter-rouge">#skip_to_end</code> がスキップした/書き込んだバイト数の数値を返すようになったことがあります。これは他の言語でもそのようになっており、書き込み中に追加の呼び出しなく現在のストリームを位置を把握できるようになります。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9233">#9233</a>と<a href="https://github.com/crystal-lang/crystal/pull/9363">#9363</a>を確認してください。</p>

<p><code class="language-plaintext highlighter-rouge">@[Experimental]</code> アノテーションという、ライブラリや言語、shardの部分に細心の注意と共に使う必要のあるという指定をするためのものが導入されました。実験的な (experimental) 機能は変更や破壊、もしくは削除を Semver の規約に関わらず行なっても良いものとします。今のところ、アノテーションはドキュメントジェネレータで利用されています。ですが、他にも追加の機能のアイディアがあります。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9244">#9244</a>を確認してください。</p>

<p><code class="language-plaintext highlighter-rouge">Digest</code> 型がリファクタリングされて、いくつかのメソッドの名前が変更されたことに注意する必要があるかもしれません。詳細は<a href="https://github.com/crystal-lang/crystal/pull/8426">#8426</a>を確認してください。</p>

<p>さて、<code class="language-plaintext highlighter-rouge">OptionParser</code> がサブコマンドを定義できるようになりました。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9009">#9009</a>を確認してください。</p>

<p>その他に整理したものとしては<a href="https://github.com/crystal-lang/crystal/pull/8886">#8886</a>で、<code class="language-plaintext highlighter-rouge">Flate</code>、<code class="language-plaintext highlighter-rouge">Gzip</code>、<code class="language-plaintext highlighter-rouge">Zip</code>、そして<code class="language-plaintext highlighter-rouge">Zlib</code> が <code class="language-plaintext highlighter-rouge">Compress</code> モジュールに移動されました。また、<code class="language-plaintext highlighter-rouge">Flate</code> は <code class="language-plaintext highlighter-rouge">Compress::Deflate</code> に名前が変更されています。<code class="language-plaintext highlighter-rouge">require "compress/gzip"</code> として、これらの定数を変更する必要があります。<code class="language-plaintext highlighter-rouge">require "gzip"</code> は依然として有効ですが、警告メッセージが表示されることになります。</p>

<p>いくつかの変更が <code class="language-plaintext highlighter-rouge">File</code> と <code class="language-plaintext highlighter-rouge">FileUtils</code> にあります。これらは整理されて、強制する操作が両方の API で有効になりました。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9175">#9175</a>を確認してください。</p>

<h3 id="マクロ">マクロ</h3>

<p>クロスコンパイルの際、<code class="language-plaintext highlighter-rouge">host_flag?</code> というマクロが追加されたことを知っておくと便利でしょう。これは <code class="language-plaintext highlighter-rouge">flag?</code> のようなものですが、ホストのマシンで解決されます。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9049">#9049</a>を確認してください。</p>

<h3 id="数値計算">数値計算</h3>

<p>符号付きと符号無しの数値の混ざった演算のオーバーフローの検出が修正されました。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9403">#9403</a>を確認してください。</p>

<p><code class="language-plaintext highlighter-rouge">Int#digits</code> というメソッドが追加されて、一貫性のため <code class="language-plaintext highlighter-rouge">BigInt#digits</code> の出力が反転されました。詳細は <a href="https://github.com/crystal-lang/crystal/pull/9383">#9383</a> を確認してください。</p>

<h3 id="シリアライズ">シリアライズ</h3>

<p><code class="language-plaintext highlighter-rouge">JSON.mapping</code> と <code class="language-plaintext highlighter-rouge">YAML.mapping</code> を使っている場合は、<a href="https://github.com/crystal-lang/json_mapping.cr">github:crystal-lang/json_mapping.cr</a> と <a href="https://github.com/crystal-lang/yaml_mapping.cr">github:crystal-lang/yaml_mapping.cr</a> に移行してください。これらの機能は十分なものでしたが、現在は <code class="language-plaintext highlighter-rouge">JSON::Serializable</code> と <code class="language-plaintext highlighter-rouge">YAML::Serializable</code> がより良いものとしてあるため、標準ライブラリから削除されました。詳細は <a href="https://github.com/crystal-lang/crystal/pull/9272">#9272</a> を確認してください。</p>

<h3 id="時刻">時刻</h3>

<p>これからは <code class="language-plaintext highlighter-rouge">Time#to_rfc3339</code> のデフォルトの精度は秒となり、それ以上の精度は出力されません。より細かな精度が必要な場合は <code class="language-plaintext highlighter-rouge">fraction_digits</code> という名前付き引数に 0. 3, 6, 9 という精度の桁数を指定してください。<a href="https://github.com/crystal-lang/crystal/pull/9283">#9283</a> で、時刻に応じて小数点以下の秒を表示する機能を削除しています。</p>

<h3 id="ネットワーク">ネットワーク</h3>

<p>SSL サーバーのデフォルト値を<a href="https://github.com/crystal-lang/crystal/pull/9026">#9026</a>で更新しました。また、<code class="language-plaintext highlighter-rouge">HTTP::Server</code> が SSL ハンドシェイク中に時折失敗する問題を<a href="https://github.com/crystal-lang/crystal/pull/9177">#9177</a>で修正しました。</p>

<p>そして、<code class="language-plaintext highlighter-rouge">HTTP::Server</code>に2つの破壊的な変更があります。エラーハンドリングとログまわりの処理を<a href="https://github.com/crystal-lang/crystal/pull/9115">#9115</a>で改善し、新しいログモジュールと統合しました。<a href="https://github.com/crystal-lang/crystal/pull/9210">#9210</a>で、<code class="language-plaintext highlighter-rouge">HTTP::Request#remote_address</code> の型を <code class="language-plaintext highlighter-rouge">Socket::Address?</code> に変更しました。</p>

<h3 id="ログ">ログ</h3>

<p>まず初めに、<a href="/2020/04/06/crystal-0.34.0-released.html">0.34.0</a>で導入した新しいログモジールを早期に試してフィードバックを送ってくださった皆様に感謝いたします。破壊的な変更を含むいくつかの変更点がありますが、それらは主要な API には影響しません。これらを組み合わせることで、追加の機能といくつかのユースケースでのパーフォマンスの改善を達成しています。</p>

<p><a href="https://github.com/crystal-lang/crystal/pull/9293">#9293</a>で <code class="language-plaintext highlighter-rouge">Log::Severity::Warning</code> を <code class="language-plaintext highlighter-rouge">Warn</code> へと名前を変更しました。<code class="language-plaintext highlighter-rouge">Log.warn { ... }</code> がありましたが、これはそのままで、警告を表します。。この変更は <code class="language-plaintext highlighter-rouge">:warning</code> やほとんどの環境変数経由での設定に影響します。同様に <code class="language-plaintext highlighter-rouge">Verbose</code> を削除して、<code class="language-plaintext highlighter-rouge">Trace</code> と <code class="language-plaintext highlighter-rouge">Notice</code> を <a href="https://github.com/crystal-lang/crystal/pull/9107">#9107</a>で追加しました。</p>

<p>ログのセットアップがよりシンプルになりました。<code class="language-plaintext highlighter-rouge">Log.setup*</code> 系の2つのメソッドがあります。これらのメソッドは常にソースとバックエンドの間のバインディングを完全に設定するでしょう。</p>

<div class="code_section">
<figure class="highlight"><pre><code class="language-crystal" data-lang="crystal"><span class="no">Log</span><span class="p">.</span><span class="nf">setup</span> <span class="ss">:debug</span> <span class="c1"># will show debug or above in the stdout for all source</span>
<span class="no">Log</span><span class="p">.</span><span class="nf">setup</span> <span class="s2">"db.*"</span><span class="p">,</span> <span class="ss">:trace</span> <span class="c1"># will show trace or above in the stdout for db.* sources and nothing else</span>
<span class="no">Log</span><span class="p">.</span><span class="nf">setup_from_env</span> <span class="c1"># will grab the value of LOG_LEVEL env variable</span></code></pre></figure>
</div>

<p><code class="language-plaintext highlighter-rouge">Log.setup_from_env</code> が1つの環境変数を受け取って動作するようになったことにも注意してください。より柔軟なものが今後追加されるかもしれませんが、名前付き引数はより良い体験を提供するはずです。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9145">#9145</a>を確認してください。</p>

<p>各エントリはこれまでより、現在実行しているファイバーから取得したコンテキストの情報を持っていました。その <code class="language-plaintext highlighter-rouge">Log::Context</code> の責務を <code class="language-plaintext highlighter-rouge">Log::Metadata</code> と <code class="language-plaintext highlighter-rouge">Log::Metadata::Value</code> に分割することにしました。前者は<code class="language-plaintext highlighter-rouge">Symbol</code> から <code class="language-plaintext highlighter-rouge">Log::Metadata::Value</code> へのハッシュのようなデータ構造ですが、アロケーションやアルゴリズム的な最適化がされています。これらは主に<a href="https://github.com/crystal-lang/crystal/pull/9227">#9227</a>と<a href="https://github.com/crystal-lang/crystal/pull/9295">#9295</a>で実装されました。これらのリファクタリングによって、クローンによって獲得していた <code class="language-plaintext highlighter-rouge">Log::Metadata::Value</code> の不変性 (immutability) が無くなりました。</p>

<p>ログエントリにローカルのメタデータや構造化された情報を追加したいという機能が望まれていました。もちろん、現在のファイバのコンテキストに対する変更や復旧が最小であるものが望ましいです。エントリが出力されていない場合は値の生成を省略するという当初の設計を保って、これを達成しました。</p>

<div class="code_section">
<figure class="highlight"><pre><code class="language-crystal" data-lang="crystal"><span class="no">Log</span><span class="p">.</span><span class="nf">info</span> <span class="p">{</span> <span class="s2">"Program started"</span> <span class="p">}</span>
<span class="no">Log</span><span class="p">.</span><span class="nf">info</span> <span class="o">&amp;</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="s2">"Program started"</span><span class="p">)</span> <span class="c1"># same as previous</span>
<span class="no">Log</span><span class="p">.</span><span class="nf">info</span> <span class="o">&amp;</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="s2">"User logged in"</span><span class="p">,</span> <span class="ss">user_id: </span><span class="mi">42</span><span class="p">)</span> <span class="c1"># local data</span>
<span class="no">Log</span><span class="p">.</span><span class="nf">info</span> <span class="o">&amp;</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="s2">"User logged in"</span><span class="p">,</span> <span class="n">expr_that_computes_hash_named_tuple_or_metadata</span><span class="p">)</span>
<span class="no">Log</span><span class="p">.</span><span class="nf">warn</span> <span class="ss">exception: </span><span class="n">e</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="s2">"Oh no!"</span><span class="p">,</span> <span class="ss">user_id: </span><span class="mi">42</span><span class="p">)</span> <span class="c1"># with exception</span>
<span class="no">Log</span><span class="p">.</span><span class="nf">warn</span> <span class="ss">exception: </span><span class="n">e</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="s2">"Oh no!"</span><span class="p">)</span> <span class="c1"># with exception, no local data</span>
<span class="no">Log</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="ss">exception: </span><span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"Oh no!"</span> <span class="p">}</span> <span class="c1"># same as previous</span>
<span class="no">Log</span><span class="p">.</span><span class="nf">info</span> <span class="o">&amp;</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="ss">action: </span><span class="s2">"log_in"</span><span class="p">,</span> <span class="ss">user_id: </span><span class="mi">42</span><span class="p">)</span> <span class="c1"># empty message</span></code></pre></figure>
</div>

<p>カスタムのログフォーマッタを作る方法は<a href="https://github.com/crystal-lang/crystal/pull/9211">#9211</a>で再検討されました。ブロックや Proc からフォーマッタを作る方法はまだ利用できますが、文字列から直接フォーマッタを定義するシンプルな方法を確認してみてください。</p>

<p>出力するログのエントリーをテストしたい場合、新しく追加された <code class="language-plaintext highlighter-rouge">Log.capture</code> というヘルパーが利用できます。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9201">#9201</a>を確認してください。</p>

<h3 id="並行処理">並行処理</h3>

<p><code class="language-plaintext highlighter-rouge">Concurrent::Future</code> とトップレベルの <code class="language-plaintext highlighter-rouge">delay</code>、<code class="language-plaintext highlighter-rouge">future</code>、<code class="language-plaintext highlighter-rouge">lazy</code> を削除しました。これらを使い続けたい場合 <a href="https://github.com/crystal-community/future.cr">github:crystal-community/future.cr</a> shard を利用してください。詳細は <a href="https://github.com/crystal-lang/crystal/pull/9093">#9093</a> を確認してください。</p>

<p>その他に<a href="https://github.com/crystal-lang/crystal/pull/9097">#9097</a>で <code class="language-plaintext highlighter-rouge">parallel</code> マクロが削除されました。</p>

<p>1.0 以降に向けて、より堅牢で様々な利用に耐えうるもの開発したいと考えています。</p>

<h3 id="ランタイム">ランタイム</h3>

<p><code class="language-plaintext highlighter-rouge">Process#signal</code> があるので <code class="language-plaintext highlighter-rouge">Process#kill</code> を非推奨としました。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9006">#9006</a>を確認してください。</p>

<p>また <code class="language-plaintext highlighter-rouge">fork</code> も非推奨となりました。これはマルチスレッド環境では有効ではありません。この変更が問題である場合は、<code class="language-plaintext highlighter-rouge">Process.fork</code> はまだ利用できるのでそちらを使ってください。しかし、このメソッドはもはや公開された API ではありません。詳細は<a href="https://github.com/crystal-lang/crystal/pull/9136">#9136</a>を確認してください。</p>

<h3 id="プラットフォーム">プラットフォーム</h3>

<p>macOS ユーザーへ、10.15 (Catalina) で起こるいくつかの互換性の問題を<a href="https://github.com/crystal-lang/crystal/pull/9296">#9296</a>で修正しました。</p>

<p>BSD のユーザーヘ、DragonFly(BSD) のサポートを<a href="https://github.com/crystal-lang/crystal/pull/9178">#9178</a>で追加しました。</p>

<p>musl ユーザーへ、奇妙な segfaults が<a href="https://github.com/crystal-lang/crystal/pull/9238">#9238</a>で、バックトレースが空になる問題が<a href="https://github.com/crystal-lang/crystal/pull/9267">#9267</a>で修正されました。</p>

<p>Windows ユーザーへはたくさんのお知らせがあります。現在進行中の取り組みを見るには <a href="https://github.com/crystal-lang/crystal/wiki/Porting-to-Windows">Wiki ページ</a>や<a href="https://github.com/crystal-lang/crystal/issues/5430">#5430</a>を確認してください。</p>

<p>今回のリリースでの Windows 向けの変更としては次のようなものがあります。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">File</code> の改善が<a href="https://github.com/crystal-lang/crystal/pull/9015">#9015</a>、<a href="https://github.com/crystal-lang/crystal/pull/9038">#9038</a>、<a href="https://github.com/crystal-lang/crystal/pull/9037">#9037</a>、<a href="https://github.com/crystal-lang/crystal/pull/9257">#9257</a>で行なわれました。</li>
  <li><code class="language-plaintext highlighter-rouge">IO</code> の振舞いが<a href="https://github.com/crystal-lang/crystal/pull/9207">#9207</a>でアラインメントされました。</li>
  <li><code class="language-plaintext highlighter-rouge">Process</code> が<a href="https://github.com/crystal-lang/crystal/pull/9047">#9047</a>と<a href="https://github.com/crystal-lang/crystal/pull/9021">#9021</a>、<a href="https://github.com/crystal-lang/crystal/pull/9122">#9122</a>、<a href="https://github.com/crystal-lang/crystal/pull/9112">#9112</a>、<a href="https://github.com/crystal-lang/crystal/pull/9149">#9149</a>、<a href="https://github.com/crystal-lang/crystal/pull/9310">#9310</a>で実装されました。</li>
  <li><code class="language-plaintext highlighter-rouge">crystal spec</code> コマンドが Windows のパスで動作するように<a href="https://github.com/crystal-lang/crystal/pull/9234">#9234</a>で修正されました。</li>
  <li>そして、コンパイラ自身を Windows 上でブートストラップできるようになりました。<a href="https://github.com/crystal-lang/crystal/pull/9054">#9054</a>、 <a href="https://github.com/crystal-lang/crystal/pull/9062">#9062</a>、 <a href="https://github.com/crystal-lang/crystal/pull/9095">#9095</a>、 <a href="https://github.com/crystal-lang/crystal/pull/9106">#9106</a>、 <a href="https://github.com/crystal-lang/crystal/pull/9307">#9307</a>。</li>
</ul>

<p>ですが、まだ標準ライブラリのすべての部分が Windows で利用できるというというわけではないことには注意してください。</p>

<h3 id="ツール">ツール</h3>

<p>主要な変更はドキュメントジェネレータで、バージョンピッカーをサポートするようになりました。外部に <code class="language-plaintext highlighter-rouge">.json</code> ファイルを用意して、現在と過去のリリースを指定することでバージョンピッカーに反映できます。詳細は<a href="https://github.com/crystal-lang/crystal/pull/8792">#8792</a>、<a href="https://github.com/crystal-lang/crystal/pull/9074">#9074</a>、それと<a href="https://github.com/crystal-lang/crystal/pull/9254">#9254</a>を確認してください。</p>

<h2 id="次のステップ">次のステップ</h2>

<p>Crystal をアップデートしてください。そして、問題の報告を心待ちにしています。私たちは1.0.0に向けての開発を始めています。1.0.0-preX のようなリリースをして、最終的な調整を重ねていくでしょう。</p>

<p>ここ数回のリリースで修正が多かったことは認めます。ですが、不快感は最小になるように心掛けたつもりです。</p>

<p>すべての非推奨にした定義は1.0では削除される予定です。1.0をクリーンなバージョンにしたいと思っています。</p>

<p><a href="https://www.84codes.com/">84codes</a>、<a href="https://nikolamotor.com/">Nikola Motor Company</a>、そして大勢の<a href="/sponsors">スポンサー</a>の継続的なサポートにたくさんの感謝をします。継続的に開発・メンテナンスを続けていくには、寄付が不可欠です。<a href="https://opencollective.com/crystal-lang">OpenCollective</a> と <a href="https://salt.bountysource.com/teams/crystal-lang">Bountysource</a> の2箇所で受け付けています。Crystal の直接のスポンサーになりたい場合や、他のサポート方法を探している場合は <a href="mailto:crystal@manas.tech">crystal@manas.tech</a> に連絡してください。それでは、ここまで読んでいただきありがとうございます！</p>


    </div>
    <div class="col m1"></div>
  </div>
</div>
</main><footer>
  <div class="row">
    <div class="col s12 m12 l6 crystal">
      Crystal is licensed under the Apache License,
      <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>
        Version 2.0
      </a>
    </div>
    <div class="col s12 m12 l6 manas right-align black-text">
      Crystal language, born & raised at
      <a href="https://manas.tech" target="_blank" class="black-text">Manas</a>
      <a href="https://manas.tech" target="_blank" class="logo">
        <i class="manas"></i>
      </a>
    </div>
  </div>
</footer>
</div><script type="text/javascript" src="/assets/bundle.js"></script> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42353458-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
